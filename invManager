local manager = peripheral.find("inventoryManager")
local owner = manager.getOwner()
local chatBox = peripheral.find("chatBox")
local chatBoxName = "Inventory Manager"
local storeChest = "front"
local takeChest = "up"

chatFunctions = {

	privateMessage = function(text, player)
		local chatMessage = {
			{text = "(Private) ", color = "gray", italic = true},
		}
		chatMessage[2] = text
		chatMessage = textutils.serializeJSON(chatMessage)
		chatBox.sendFormattedMessageToPlayer(chatMessage, player, chatBoxName)
	end

}

functions = {

	take = function(commands)
		local desiredItem = string.lower(commands[1])
		local desiredQuantity = tonumber(commands[2])
		
		if desiredQuantity == nil or desiredQuantity < 1 then 
			desiredQuantity = 1 
		end
		
		if manager.getFreeSlot() ~= -1 then
		
			local value, value2 = manager.addItemToPlayer(takeChest, {name=desiredItem, count = desiredQuantity})
			if value > 0 and value2 == nil then --Successful
				chatFunctions.privateMessage({text = "Took "..value.." "..desiredItem..".", color = "green", bold = true}, owner)
			elseif value2 == "ITEM_NOT_FOUND" then --Incorrect Command
				chatFunctions.privateMessage({text = "Improper item name (mod:item_name)", color = "red", bold = true}, owner)
			elseif value2 == nil then --Chest does not have item
				chatFunctions.privateMessage({text = "Chest does not contain item.", color = "red", bold = true}, owner)
			else --Other error
				chatFunctions.privateMessage({text = "Error (Show Gamer):".. value2, color = "red", bold = true}, owner)
			end
			
		else
			chatFunctions.privateMessage({text = "No empty space in inventory.", color = "red", bold = true}}, owner)
		end
	end,
	
	store = function(commands)
	
		local desiredItem = manager.getItemInHand()
		local desiredQuantity = tonumber(commands[1])
		
		if desiredQuantity == nil or desiredQuantity < 1 then 
			desiredQuantity = desiredItem.count
		end
		
		if desiredItem.name ~= nil then
			local value, value2 = manager.removeItemFromPlayer(storeChest, {name=desiredItem.name, count=desiredQuantity})
			if value > 0 and value2 == nil then --Successful
				chatFunctions.privateMessage({text = "Stored "..value.." "..desiredItem.name..".", color = "green", bold = true}, owner)
			elseif value2 == "INVENTORY_TO_INVALID" then --No Chest
				chatFunctions.privateMessage({text = "No chest to store items.", color = "red", bold = true}, owner)
			elseif value == 0 then --Chest has no storage
				chatFunctions.privateMessage({text = "Chest is full.", color = "red", bold = true}, owner)
			else --Other Error
				chatFunctions.privateMessage({text = "Error (Show Gamer):".. value2, color = "red", bold = true}, owner)
			end
		else --No item in hand
			local chatMessage = {
				{text = "(Private) ", color = "gray", italic = true},
				{text = "No item in hand.", color = "red", bold = true}
			}
			chatMessage = textutils.serializeJSON(chatMessage)
			
			chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)	
		end
		
	end

}

while true do

	local event, user, message, uuid, isHidden = os.pullEvent("chat")
	if isHidden and user == "EnchantedAlchemy" then
		
		local commands = {}
		
		for s in string.gmatch(message, "[%w:_]+") do
			commands[#commands+1] = s
		end
		
		local mainCommand = commands[1]
		table.remove(commands,1)
		
		if functions[mainCommand] ~= nil then
			functions[mainCommand](commands)
		end
		
	end

end
