local manager = peripheral.find("inventoryManager")
local owner = manager.getOwner()
local chatBox = peripheral.find("chatBox")
local chatBoxName = "Inventory Manager"
local storeChest = "front"
local takeChest = "up"

functions = {

	takeItem = function(commands)
		local desiredItem = string.lower(commands[1])
		local desiredQuantity = tonumber(commands[2])
		
		if desiredQuantity == nil or desiredQuantity < 1 then 
			desiredQuantity = 1 
		end
		
		if manager.getFreeSlot() ~= -1 then
		
			local value, value2 = manager.addItemToPlayer(takeChest, {name=desiredItem, toSlot = manager.getFreeSlot(), count = desiredQuantity})
			if value > 0 and value2 == nil then --Successful
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Gave "..value.." "..desiredItem..".", color = "green", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			elseif value2 == "ITEM_NOT_FOUND" then --Incorrect Command
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Improper item name (mod:item_name)", color = "red", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			elseif value2 == nil then --Chest does not have item
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Chest does not contain item.", color = "red", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			else --Other error
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Error:".. value2, color = "red", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			end
			
		else
			local chatMessage = {
				{text = "(Private) ", color = "gray", italic = true},
				{text = "No empty space in inventory.", color = "red", bold = true}
			}
			chatMessage = textutils.serializeJSON(chatMessage)
			
			chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)	
		end
	end,
	
	storeItem = function(commands)
	
		local desiredItem = manager.getItemInHand()
		local desiredQuantity = tonumber(commands[2])
		
		if desiredQuantity == nil or desiredQuantity < 1 then 
			desiredQuantity = desiredItem.count
		end
		
		if desiredItem.name ~= nil then
			local value, value2 = manager.removeItemFromPlayer(storeChest, {name=desiredItem.name, count=desiredQuantity})
			if value > 0 and value2 == nil then --Successful
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Stored "..value.." "..desiredItem.name..".", color = "green", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			elseif value2 == then "INVENTORY_TO_INVALID" --No Chest
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "No chest to store items.", color = "red", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			elseif value == 0 then --Chest has no storage
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Chest is full.", color = "red", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			else --Other Error
				local chatMessage = {
					{text = "(Private) ", color = "gray", italic = true},
					{text = "Error:".. value2, color = "red", bold = true}
				}
				chatMessage = textutils.serializeJSON(chatMessage)
				
				chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)
			end
		else --No item in hand
			local chatMessage = {
				{text = "(Private) ", color = "gray", italic = true},
				{text = "No item in hand.", color = "red", bold = true}
			}
			chatMessage = textutils.serializeJSON(chatMessage)
			
			chatBox.sendFormattedMessageToPlayer(chatMessage, owner, chatBoxName)	
		end
		
	end

}

while true do

	local event, user, message, uuid, isHidden = os.pullEvent("chat")
	if isHidden and user == "EnchantedAlchemy" then
		
		local commands = {}
		
		for s in string.gmatch(message, "[%w:_]+") do
			commands[#commands+1] = s
		end
		
		local mainCommand = commands[1]
		table.remove(commands,1)
		
		if functions[mainCommand] ~= nil then
			functions[mainCommand](commands)
		end
		
	end

end
